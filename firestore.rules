rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isMember(docData, key) {
      return isSignedIn() && key in docData && request.auth.uid in docData[key];
    }

    function isRelationalIdImmutable(path) {
      return request.resource.data[path] == resource.data[path];
    }

    function isSuperAdmin() {
      return request.auth.uid == 'ebixEzJ8UuYjIYTXrkOObW1obSw1';
    }

    // -------------------------------------------------------------------------
    // USER PROFILES
    // -------------------------------------------------------------------------
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isOwner(userId) && request.resource.data.id == userId;

      allow update: if isRelationalIdImmutable('id')
                    && (
                      (isExistingOwner(userId) &&
                       (!('followerIds' in request.resource.data) ||
                        request.resource.data.followerIds == resource.data.followerIds))
                      ||
                      (isSignedIn()
                       && 'followerIds' in request.resource.data
                       && (
                         (!('followerIds' in resource.data) ||
                          !(request.auth.uid in resource.data.followerIds))
                         ||
                         ('followerIds' in resource.data &&
                          request.auth.uid in resource.data.followerIds)
                       ))
                    );

      allow delete: if isExistingOwner(userId);
    }

    // -------------------------------------------------------------------------
    // POSTS
    // -------------------------------------------------------------------------
    match /posts/{postId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.author.id == request.auth.uid;

      allow update: if isSignedIn() && (
        resource.data.author.id == request.auth.uid ||
        (request.resource.data.author.id == resource.data.author.id &&
         request.resource.data.content == resource.data.content &&
         request.resource.data.comments is int &&
         request.resource.data.comments >= 0)
      );

      allow delete: if isSignedIn() && resource.data.author.id == request.auth.uid;

      match /comments/{commentId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn() && request.resource.data.author.id == request.auth.uid;
        allow update, delete: if isSignedIn() && resource.data.author.id == request.auth.uid;
      }
    }

    // -------------------------------------------------------------------------
    // CHATS
    // -------------------------------------------------------------------------
    match /chats/{chatId} {
      allow get: if isMember(resource.data, 'participants');
      allow list: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow create: if isMember(request.resource.data, 'participants');
      allow update: if false;
      allow delete: if false;

      match /messages/{messageId} {
        allow get, list: if isMember(get(/databases/$(database)/documents/chats/$(chatId)).data, 'participants');
        allow create: if isMember(get(/databases/$(database)/documents/chats/$(chatId)).data, 'participants')
                      && request.resource.data.senderId == request.auth.uid
                      && request.resource.data.chatId == chatId;
        allow update: if isExistingOwner(resource.data.senderId)
                      && isRelationalIdImmutable('senderId')
                      && isRelationalIdImmutable('chatId');
        allow delete: if isExistingOwner(resource.data.senderId);
      }
    }

    // -------------------------------------------------------------------------
    // COMMUNITIES
    // -------------------------------------------------------------------------
    match /communities/{communityId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.leaderId == request.auth.uid;
      allow update: if isOwner(resource.data.leaderId);
      allow delete: if isOwner(resource.data.leaderId);
    }

    // -------------------------------------------------------------------------
    // KITTY GROUPS
    // -------------------------------------------------------------------------
    match /kitty_groups/{kittyGroupId} {
      allow get: if isMember(resource.data, 'memberIds')
                 || isSuperAdmin()
                 || (isSignedIn() && 'orderId' in resource.data && resource.data.orderId != null && resource.data.orderId != '');

      allow list: if isSignedIn() && (
        // Require query to have filters (prevents blind lists)
        // Allow if query has where clause, orderBy, or limit (indicates it's not a blind list)
        request.query.where.size() > 0 ||
        request.query.orderBy.size() > 0 ||
        request.query.limit != null ||
        // Super Admin sees all
        isSuperAdmin()
      );

      allow create: if isSignedIn() && isMember(request.resource.data, 'memberIds');

      allow update: if isSuperAdmin()
        || (isSignedIn() &&
           ((resource.data.memberIds.size() > 0 &&
             resource.data.memberIds[0] == request.auth.uid &&
             (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberIds']) ||
              request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'contribution']) ||
              request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberIds', 'name', 'contribution'])))
            ||
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberIds']) &&
             request.resource.data.memberIds.hasAll(resource.data.memberIds) &&
             request.resource.data.memberIds.size() == resource.data.memberIds.size() + 1 &&
             request.auth.uid in request.resource.data.memberIds &&
             !(request.auth.uid in resource.data.memberIds))));

      allow delete: if isSuperAdmin()
        || (isSignedIn() &&
           resource.data.memberIds.size() > 0 &&
           resource.data.memberIds[0] == request.auth.uid);
    }

    // -------------------------------------------------------------------------
    // ðŸ”¥ TAMBOLA GAMES (FIXED LIST RULE)
    // -------------------------------------------------------------------------
    // ----------------------------------------------------
    // TAMBOLA GAMES
    // ----------------------------------------------------
    match /tambola_games/{gameId} {
      // ---------------------------
      // LIST FIX â€” VERY IMPORTANT
      // ---------------------------
      // Must have where filters. Prevent blind list.
      // NOTE: resource.data is NOT available in list queries, only in get/update/delete
      // Allow if query has where clause, limit, or orderBy (indicates it's not a blind list)
      allow list: if isSignedIn() && (
        request.query.where.size() > 0 ||
        request.query.limit != null ||
        request.query.orderBy.size() > 0 ||
        isSuperAdmin()
      );

      // ---------------------------
      // CREATE GAME (Only hosts)
      // ---------------------------
      allow create: if isSignedIn();

      // ---------------------------
      // READ GAME
      // ---------------------------
      allow get: if isSignedIn() && (
        // host/admin (using adminId to match our codebase)
        request.auth.uid == resource.data.adminId ||
        // player
        (resource.data.playerIds != null &&
         request.auth.uid in resource.data.playerIds) ||
        // order-based access
        (resource.data.orderId != null &&
         resource.data.orderId != "") ||
        // elevated access
        isSuperAdmin()
      );

      // ---------------------------
      // UPDATE GAME
      // ---------------------------
      allow update: if isSignedIn() && (
        // only host/admin can update the game
        request.auth.uid == resource.data.adminId ||
        isSuperAdmin()
      );

      // ---------------------------
      // DELETE GAME
      // ---------------------------
      allow delete: if isSuperAdmin();
    }

    // -------------------------------------------------------------------------
    // MARKETPLACE
    // -------------------------------------------------------------------------
    match /marketplace_listings/{listingId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.sellerId) && isRelationalIdImmutable('sellerId');
      allow delete: if isExistingOwner(resource.data.sellerId);
    }

    // -------------------------------------------------------------------------
    // DIRECTORY
    // -------------------------------------------------------------------------
    match /directory/{professionalId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSuperAdmin();
    }

    // -------------------------------------------------------------------------
    // COURSES
    // -------------------------------------------------------------------------
    match /courses/{courseId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.instructorId == request.auth.uid;
      allow update: if isOwner(resource.data.instructorId);
      allow delete: if isOwner(resource.data.instructorId);
    }

    // -------------------------------------------------------------------------
    // CONTESTS
    // -------------------------------------------------------------------------
    match /contests/{contestId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSuperAdmin();

      match /votes/{voteId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update, delete: if false;
      }
    }

    // -------------------------------------------------------------------------
    // NOMINATIONS
    // -------------------------------------------------------------------------
    match /nominations/{nominationId} {
      allow get: if isSignedIn() &&
        (resource.data.userId == request.auth.uid || isSuperAdmin());

      allow list: if isSignedIn() &&
        (resource.data.userId == request.auth.uid || isSuperAdmin());

      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;

      allow update, delete: if isSuperAdmin();
    }

    // -------------------------------------------------------------------------
    // NOMINEE COMMENTS
    // -------------------------------------------------------------------------
    match /nominee_comments/{commentId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() &&
                    request.resource.data.author.id == request.auth.uid;
      allow update, delete: if isSuperAdmin();
    }

    // -------------------------------------------------------------------------
    // EVENTS
    // -------------------------------------------------------------------------
    match /events/{eventId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() &&
                    request.resource.data.organizerId == request.auth.uid;
      allow update: if isOwner(resource.data.organizerId);
      allow delete: if isOwner(resource.data.organizerId);
    }

    // -------------------------------------------------------------------------
    // PROFESSIONAL APPLICATIONS
    // -------------------------------------------------------------------------
    match /professional_applications/{applicationId} {
      allow get, list, update, delete: if isSuperAdmin();
      allow create: if isOwner(request.resource.data.userId);
    }

    // -------------------------------------------------------------------------
    // NOTIFICATIONS
    // -------------------------------------------------------------------------
    match /notifications/{notificationId} {
      allow get: if isSignedIn() &&
                  (resource == null || resource.data.userId == request.auth.uid);

      allow list: if isSignedIn() && resource.data.userId == request.auth.uid;

      allow create: if isSignedIn() &&
                    request.resource.data.userId == request.auth.uid;

      allow update: if isSignedIn() &&
                    resource.data.userId == request.auth.uid;

      allow delete: if isSignedIn() &&
                    resource.data.userId == request.auth.uid;
    }

    // -------------------------------------------------------------------------
    // NOTIFICATION PREFERENCES
    // -------------------------------------------------------------------------
    match /notification_preferences/{preferenceId} {
      allow get, list, create, update, delete:
        if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // -------------------------------------------------------------------------
    // PAYMENTS
    // -------------------------------------------------------------------------
    match /payments/{paymentId} {
      allow get: if isSignedIn() &&
                 (resource == null || resource.data.userId == request.auth.uid);

      allow list: if isSignedIn() && resource.data.userId == request.auth.uid;

      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.userId is string
        && request.resource.data.amount is number
        && request.resource.data.currency is string
        && request.resource.data.status == 'pending';

      allow update: if isSignedIn() &&
                    resource.data.userId == request.auth.uid &&
                    (!('userId' in request.resource.data)
                      || request.resource.data.userId == resource.data.userId);

      allow delete: if false;
    }

    // -------------------------------------------------------------------------
    // REFUNDS
    // -------------------------------------------------------------------------
    match /refunds/{refundId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if false;
    }

    // -------------------------------------------------------------------------
    // JOIN REQUESTS
    // -------------------------------------------------------------------------
    
    // Tambola Game Join Requests
    match /tambola_game_join_requests/{requestId} {
      // Users can create their own join requests
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // Users can read their own requests, admins can read requests for their games
      allow get: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.tambolaGameId != null && 
         get(/databases/$(database)/documents/tambola_games/$(resource.data.tambolaGameId)).data.adminId == request.auth.uid) ||
        isSuperAdmin()
      );
      
      // Users can list their own requests, admins can list requests for their games
      allow list: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.tambolaGameId != null && 
         get(/databases/$(database)/documents/tambola_games/$(resource.data.tambolaGameId)).data.adminId == request.auth.uid) ||
        isSuperAdmin()
      );
      
      // Only admins can update (approve/reject) requests for their games
      allow update: if isSignedIn() && (
        (resource.data.tambolaGameId != null && 
         get(/databases/$(database)/documents/tambola_games/$(resource.data.tambolaGameId)).data.adminId == request.auth.uid) ||
        isSuperAdmin()
      );
      
      allow delete: if isSuperAdmin();
    }
    
    // Kitty Group Join Requests
    match /kitty_group_join_requests/{requestId} {
      // Users can create their own join requests
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // Users can read their own requests, admins can read requests for their groups
      allow get: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.kittyGroupId != null && 
         resource.data.kittyGroupId in get(/databases/$(database)/documents/kitty_groups/$(resource.data.kittyGroupId)).data.memberIds &&
         get(/databases/$(database)/documents/kitty_groups/$(resource.data.kittyGroupId)).data.memberIds[0] == request.auth.uid) ||
        isSuperAdmin()
      );
      
      // Users can list their own requests, admins can list requests for their groups
      allow list: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.kittyGroupId != null && 
         resource.data.kittyGroupId in get(/databases/$(database)/documents/kitty_groups/$(resource.data.kittyGroupId)).data.memberIds &&
         get(/databases/$(database)/documents/kitty_groups/$(resource.data.kittyGroupId)).data.memberIds[0] == request.auth.uid) ||
        isSuperAdmin()
      );
      
      // Only group creator (first member) can update (approve/reject) requests
      allow update: if isSignedIn() && (
        (resource.data.kittyGroupId != null && 
         get(/databases/$(database)/documents/kitty_groups/$(resource.data.kittyGroupId)).data.memberIds[0] == request.auth.uid) ||
        isSuperAdmin()
      );
      
      allow delete: if isSuperAdmin();
    }

    // -------------------------------------------------------------------------
    // NAARI FANTASY ZONE
    // -------------------------------------------------------------------------
    
    // Fantasy Games
    match /fantasy_games/{gameId} {
      allow get: if isSignedIn();
      
      // Super admins can list all games
      // Regular users need filtered queries (where/orderBy/limit)
      allow list: if isSignedIn() && (
        isSuperAdmin() ||
        (request.query.where.size() > 0) ||
        (request.query.orderBy.size() > 0) ||
        (request.query.limit != null)
      );
      
      allow create, update, delete: if isSuperAdmin();
    }
    
    // Fantasy Questions
    match /fantasy_questions/{questionId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSuperAdmin();
    }
    
    // Fantasy Events
    match /fantasy_events/{eventId} {
      allow get: if isSignedIn();
      // Allow list queries - Firestore requires where/orderBy/limit which our queries have
      allow list: if isSignedIn();
      allow create, update, delete: if isSuperAdmin();
    }
    
    // User Predictions
    match /user_predictions/{predictionId} {
      // Users can create their own predictions
      // Ensure userId matches authenticated user and required fields are present
      allow create: if isSignedIn() && 
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.gameId != null &&
        request.resource.data.questionId != null &&
        request.resource.data.prediction != null;
      
      // Users can read their own predictions, admins can read all
      allow get: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        isSuperAdmin()
      );
      
      // Users can list their own predictions, admins can list all
      allow list: if isSignedIn() && (
        request.query.where.size() > 0 || // Must have where clause
        request.query.orderBy.size() > 0 ||
        request.query.limit != null ||
        isSuperAdmin()
      );
      
      // Users can update their own predictions (before deadline), admins can update all
      allow update: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        isSuperAdmin()
      );
      
      allow delete: if isSuperAdmin();
    }
    
    // Fantasy Results
    match /fantasy_results/{resultId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSuperAdmin();
    }
    
    // Leaderboards
    match /leaderboards/{leaderboardId} {
      // All signed-in users can read leaderboards
      allow get, list: if isSignedIn();
      // Only super admins can create/update/delete leaderboards
      allow create, update, delete: if isSuperAdmin();
    }
    
    // User Wallets (Coins)
    match /user_wallets/{walletId} {
      // Users can read their own wallet (walletId should match userId)
      allow get: if isSignedIn() && (
        walletId == request.auth.uid ||
        (resource != null && resource.data.userId == request.auth.uid) ||
        isSuperAdmin()
      );
      
      // Super admins can list all wallets, regular users need filtered queries
      allow list: if isSignedIn() && (
        isSuperAdmin() ||
        request.query.where.size() > 0 ||
        request.query.orderBy.size() > 0 ||
        request.query.limit != null
      );
      
      // Users can create their own wallet (walletId must match userId)
      allow create: if isSignedIn() && 
        walletId == request.auth.uid &&
        request.resource.data.userId == request.auth.uid;
      
      // Users can update their own wallet, admins can update any
      allow update: if isSignedIn() && (
        walletId == request.auth.uid ||
        (resource != null && resource.data.userId == request.auth.uid) ||
        isSuperAdmin()
      );
      
      allow delete: if isSuperAdmin();
      
      allow delete: if false; // Wallets should never be deleted
    }
    
    // Coin Transactions
    match /coin_transactions/{transactionId} {
      // Users can read their own transactions
      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Super admins can list all transactions, regular users need filtered queries
      allow list: if isSignedIn() && (
        isSuperAdmin() ||
        request.query.where.size() > 0
      );
      
      // System can create transactions (via admin or server functions)
      allow create: if isSignedIn();
      
      // No updates or deletes allowed
      allow update, delete: if false;
    }
    
    // User Badges
    match /user_badges/{badgeId} {
      // Users can read their own badges
      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Super admins can list all badges, regular users need filtered queries
      allow list: if isSignedIn() && (
        isSuperAdmin() ||
        request.query.where.size() > 0
      );
      
      // System can create badges (via admin or server functions)
      allow create: if isSignedIn();
      
      // No updates or deletes allowed
      allow update, delete: if false;
    }
    
    // Leaderboards
    match /leaderboards/{leaderboardId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSuperAdmin();
    }
    
    // Fantasy Campaigns
    match /fantasy_campaigns/{campaignId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSuperAdmin();
    }

    // -------------------------------------------------------------------------
    // AD & SPONSORSHIP SYSTEM
    // -------------------------------------------------------------------------
    
    // Ad Campaigns
    match /ad_campaigns/{campaignId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSuperAdmin();
    }
    
    // Ad Creatives
    match /ad_creatives/{creativeId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSuperAdmin();
    }
    
    // Ad Placement Rules
    match /ad_placement_rules/{ruleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSuperAdmin();
    }
    
    // Sponsors
    match /sponsors/{sponsorId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSuperAdmin();
    }
    
    // Ad Impressions (tracking)
    match /ad_impressions/{impressionId} {
      allow create: if isSignedIn();
      allow get, list, update, delete: if isSuperAdmin();
    }
    
    // Ad Clicks (tracking)
    match /ad_clicks/{clickId} {
      allow create: if isSignedIn();
      allow get, list, update, delete: if isSuperAdmin();
    }
    
    // Ad Conversions (tracking)
    match /ad_conversions/{conversionId} {
      allow create: if isSignedIn();
      allow get, list, update, delete: if isSuperAdmin();
    }
    
    // Real-Time CTR (performance tracking)
    match /ad_real_time_ctr/{ctrId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSuperAdmin();
    }
    
    // Ad Notifications
    match /ad_notifications/{notificationId} {
      allow create: if isSignedIn();
      allow get, list, update, delete: if isSuperAdmin();
    }

    // -------------------------------------------------------------------------
    // PAYMENT WEBHOOKS
    // -------------------------------------------------------------------------
    match /payment_webhooks/{webhookId} {
      allow create: if isSignedIn();
      allow read: if false;
      allow update, delete: if false;
    }

    // -------------------------------------------------------------------------
    // REDEEMABLE ITEMS (REWARDS CATALOG)
    // -------------------------------------------------------------------------
    match /redeemable_items/{itemId} {
      // Anyone signed in can read active items
      allow get: if isSignedIn();
      
      // List queries must have filters (where clause, orderBy, or limit)
      allow list: if isSignedIn() && (
        request.query.where.size() > 0 ||
        request.query.orderBy.size() > 0 ||
        request.query.limit != null ||
        isSuperAdmin()
      );
      
      // Only super admins can create, update, or delete items
      allow create, update, delete: if isSuperAdmin();
    }

    // -------------------------------------------------------------------------
    // USER REDEMPTIONS
    // -------------------------------------------------------------------------
    match /user_redemptions/{redemptionId} {
      // Users can read their own redemptions
      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Users can list their own redemptions
      // Super admins can list all redemptions
      allow list: if isSignedIn() && (
        request.query.where.size() > 0 ||
        request.query.orderBy.size() > 0 ||
        request.query.limit != null ||
        isSuperAdmin()
      );
      
      // Users can create redemptions (redeem items)
      allow create: if isSignedIn() && 
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.itemId != null &&
        request.resource.data.coinCost != null;
      
      // Only super admins can update redemptions (approve, fulfill, etc.)
      allow update, delete: if isSuperAdmin();
    }
  }
}
